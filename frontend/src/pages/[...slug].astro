---
import Layout from '../layouts/Layout.astro';
import { craftClient } from '../lib/graphql';
import { getPreviewStatus, PreviewScript } from '../lib/preview';
import { PAGE_QUERY } from '../queries/pages.mjs';
import ContentBlocks from '../components/ContentBlocks.astro';

const { slug } = Astro.params;
const uri = Array.isArray(slug) ? slug.join('/') : slug;
const preview = getPreviewStatus(Astro.url);

const data = await craftClient.query(PAGE_QUERY, { uri }, {
  previewToken: preview.token
});

const entry = data?.entry;

if (!entry) {
  return Astro.redirect('/404');
}
---

<Layout title={entry.title}>
  <main data-template="pageSlug" data-layout="page">

    <header class="pageHeader">
      {entry.image?.[0] && (
        <figure>
          <img src={entry.image[0].url} alt={entry.image[0].alt} />
        </figure>
      )}

      <div class="">
        {entry.ancestors?.length > 0 && (
          <ul class="">
            {entry.ancestors.map((ancestor: any) => (
              <li>
                <a href={`/${ancestor.uri}`}>{ancestor.title}</a>
              </li>
            ))}
          </ul>
        )}

        <h1 class="">{entry.title}</h1>
        {entry.pageSubheading && (
          <p class="mt-4">{entry.pageSubheading}</p>
        )}
      </div>
    </header>


    {entry.pageContent?.chunks && (
      <div class="pageContent prose">
        <ContentBlocks chunks={entry.pageContent.chunks} />
      </div>
    )}
    
    {entry.children?.length > 0 && (
      <div class="">
        <h2 class="">Child Pages</h2>
        <ul>
          {entry.children.map((child: any) => (
            <li>
              <a href={`/${child.uri}`} class="">
                {child.title}
              </a>
            </li>
          ))}
        </ul>
      </div>
    )}
  </main>
</Layout>

<Fragment set:html={PreviewScript({ isPreview: preview.isPreview })} /> 

<style scoped>
  :where(main) {
    padding-block: 2rem;
  }
</style>